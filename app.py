import streamlit as st
import pandas as pd
import numpy as np

st.set_page_config(page_title="Full WACC Model (Textbook Example)", layout="centered")

st.title("ğŸ“˜ Weighted Average Cost of Capital â€” Multi-Source Example")

st.markdown("""
This version replicates the **textbook WACC example** including:
- Ordinary shares (equity) using the **Gordon Growth Model**  
- Preference shares  
- Redeemable bonds (Hawawiniâ€“Vora yield)  
- Irredeemable bonds  
- Bank loans (after tax)

Each cost is adjusted for tax as applicable, and weighted by market value.
""")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Default Data from the image example
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.header("Step 1ï¸âƒ£  â€”  Input Data")

tax_rate = st.number_input("Corporation tax rate (%)", value=30.0, step=0.1)

data = [
    {"Source": "Ordinary shares", "Market Value (Â£m)": 417, "Cost (%)": 10.8, "After-Tax?": False},
    {"Source": "Preference shares", "Market Value (Â£m)": 89, "Cost (%)": 9.0, "After-Tax?": False},
    {"Source": "Redeemable bonds", "Market Value (Â£m)": 96, "Cost (%)": 5.8, "After-Tax?": True},
    {"Source": "Irredeemable bonds", "Market Value (Â£m)": 108, "Cost (%)": 9.0, "After-Tax?": True},
    {"Source": "Bank loans", "Market Value (Â£m)": 7, "Cost (%)": 7.0, "After-Tax?": True},
]
df = pd.DataFrame(data)

st.dataframe(df, use_container_width=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Apply tax adjustment
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
df["Effective Cost (%)"] = np.where(
    df["After-Tax?"],
    df["Cost (%)"] * (1 - tax_rate / 100),
    df["Cost (%)"]
)

df["Total Value"] = df["Market Value (Â£m)"]
total_capital = df["Total Value"].sum()
df["Weight"] = df["Total Value"] / total_capital
df["Weighted Cost (%)"] = df["Weight"] * df["Effective Cost (%)"]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Display results
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.header("Step 2ï¸âƒ£  â€”  Weighted Average Calculation")
st.write(f"**Total Market Value (V)** = Â£{total_capital:,.0f} million")

st.dataframe(
    df[["Source", "Market Value (Â£m)", "Effective Cost (%)", "Weight", "Weighted Cost (%)"]],
    use_container_width=True
)

wacc = df["Weighted Cost (%)"].sum()

st.success(f"âœ… **Weighted Average Cost of Capital (WACC) = {wacc:.2f}%**")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Detailed workings
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.expander("Show formula and interpretation"):
    st.latex(r"""
    WACC = \sum_i w_i K_i (1 - T_i)
    """)
    st.markdown(f"""
    **Effective after-tax rates (as in example):**
    - Redeemable bonds: 5.8 Ã— (1âˆ’0.30) = 4.1 %
    - Irredeemable bonds: 9 Ã— (1âˆ’0.30) = 5.8 %
    - Bank loans: 7 Ã— (1âˆ’0.30) = 4.9 %

    Weighted together:
    \\[
    WACC = {wacc:.2f}\%
    \\]
    """)

st.caption("Generated by AI (ChatGPT) under supervision of A. McBride â€” textbook replication, WACC multi-source edition.")
